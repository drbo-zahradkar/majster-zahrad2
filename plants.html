<script>
  const yearEl = document.getElementById('year');
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  const list = document.getElementById('plantList');
  const searchInput = document.getElementById('plantSearch');
  const autocompleteBox = document.getElementById('autocomplete');
  const TOKEN = "usr-51E-rQa5pgTQmyLBFRNAINUXBDAmYyCAaBHAOD-LjZ8";

  let plants = [];

  async function searchPlants(q) {
    try {
      const res = await fetch(`https://trefle.io/api/v1/plants/search?token=${TOKEN}&q=${encodeURIComponent(q)}`);
      const data = await res.json();
      plants = data.data.map(p => ({
        name: p.common_name || "Neznáma rastlina",
        latin: p.scientific_name || "—",
        img: p.image_url || "https://via.placeholder.com/300x200?text=Bez+obrázka"
      }));
      renderPlants(plants);
      showAutocomplete(plants);
    } catch (err) {
      console.error(err);
      list.innerHTML = "<p>Nepodarilo sa načítať rastliny 😢</p>";
    }
  }

  function renderPlants(data) {
    list.innerHTML = '';
    if (data.length === 0) {
      list.innerHTML = '<p>Nenašli sa žiadne rastliny.</p>';
      return;
    }
    data.forEach(plant => {
      const card = document.createElement('div');
      card.className = 'plant-card';
      card.innerHTML = `
        <img src="${plant.img}" alt="${plant.name}">
        <h3>${plant.name}</h3>
        <div class="latin">${plant.latin}</div>
      `;
      list.appendChild(card);
    });
  }

  function showAutocomplete(suggestions) {
    if (suggestions.length === 0) {
      autocompleteBox.style.display = 'none';
      return;
    }
    autocompleteBox.innerHTML = '';
    suggestions.forEach(plant => {
      const item = document.createElement('div');
      item.className = 'autocomplete-item';
      item.textContent = plant.name;
      item.addEventListener('click', () => {
        searchInput.value = plant.name;
        renderPlants([plant]);
        autocompleteBox.style.display = 'none';
      });
      autocompleteBox.appendChild(item);
    });
    autocompleteBox.style.display = 'block';
  }

  searchInput.addEventListener('input', () => {
    const q = searchInput.value.toLowerCase().trim();
    if (q.length >= 2) {
      searchPlants(q);
    } else {
      autocompleteBox.style.display = 'none';
      list.innerHTML = '<p>Zadaj aspoň 2 písmená na vyhľadávanie 🌿</p>';
    }
  });

  document.addEventListener('click', (e) => {
    if (!autocompleteBox.contains(e.target) && e.target !== searchInput) {
      autocompleteBox.style.display = 'none';
    }
  });

  document.getElementById('resetFilters').addEventListener('click', () => {
    searchInput.value = '';
    autocompleteBox.style.display = 'none';
    list.innerHTML = '<p>Zadaj názov rastliny a vyhľadaj 🌿</p>';
    plants = [];
  });
</script>
